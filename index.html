<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´å¼ç å¿ƒç®—ç·´ç¿’å· (å–®æ©Ÿåˆ—å°ç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS (ç¾åŒ–æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åˆ—å°æ™‚çš„ç‰¹åˆ¥è¨­å®š */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }

            .print-break-inside-avoid {
                break-inside: avoid;
            }
        }

        /* æ¨¡æ“¬ A4 ç´™å¼µ */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            box-sizing: border-box;
        }

        @media print {
            .a4-paper {
                box-shadow: none;
                margin: 0;
                width: 100%;
                padding: 0.5cm;
                /* åˆ—å°æ™‚é‚Šè·ç¨å¾®ç¸®å° */
            }
        }
    </style>
</head>

<body class="bg-gray-100 py-8 font-sans text-gray-800">

    <!-- æ§åˆ¶é¢æ¿ (åˆ—å°æ™‚æœƒéš±è—) -->
    <div class="no-print max-w-[210mm] mx-auto mb-6 bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <h1 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
            ğŸ§® ç›´å¼ç å¿ƒç®—ç·´ç¿’å· (å–®æ©Ÿç‰ˆ)
        </h1>

        <div class="flex flex-wrap gap-6 items-end">
            <!-- è¨­å®šï¼šå£æ•¸ -->
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">å£æ•¸ (å¹¾å€‹æ•¸å­—ç›¸åŠ )</label>
                <select id="rowsCount"
                    class="w-32 border-2 border-gray-300 rounded-lg p-2 text-lg focus:border-blue-500 outline-none">
                    <option value="2">2 å£</option>
                    <option value="3" selected>3 å£ (åˆå­¸)</option>
                    <option value="4">4 å£</option>
                    <option value="5">5 å£</option>
                    <option value="6">6 å£</option>
                </select>
            </div>

            <!-- è¨­å®šï¼šæ’æ•¸ -->
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">é¡Œé‡ (æ’æ•¸)</label>
                <select id="blockCount"
                    class="w-32 border-2 border-gray-300 rounded-lg p-2 text-lg focus:border-blue-500 outline-none">
                    <option value="2">2 æ’ (20é¡Œ)</option>
                    <option value="3">3 æ’ (30é¡Œ)</option>
                    <option value="4" selected>4 æ’ (40é¡Œ)</option>
                    <option value="5">5 æ’ (50é¡Œ)</option>
                </select>
            </div>

            <!-- æŒ‰éˆ•å€ -->
            <div class="flex gap-3">
                <button onclick="toggleAnswers()" id="btnAnswer"
                    class="px-4 py-2 bg-white border-2 border-blue-500 text-blue-600 font-bold rounded-lg hover:bg-blue-50 transition">
                    é¡¯ç¤ºç­”æ¡ˆ
                </button>
                <button onclick="generateSheet()"
                    class="px-4 py-2 bg-green-100 text-green-700 font-bold rounded-lg hover:bg-green-200 border-2 border-green-200 transition flex items-center gap-1">
                    ğŸ”„ æ›é¡Œ
                </button>
                <button onclick="window.print()"
                    class="px-6 py-2 bg-gray-900 text-white font-bold rounded-lg hover:bg-gray-700 shadow-lg transition flex items-center gap-1">
                    ğŸ–¨ï¸ åˆ—å°
                </button>
            </div>
        </div>
        <p class="text-gray-500 text-sm mt-4">
            ğŸ’¡ æç¤ºï¼šæ­¤ç‰ˆæœ¬ç‚ºå–®æ©Ÿç¶²é ç‰ˆï¼Œè«‹ç›´æ¥ä½¿ç”¨ç€è¦½å™¨çš„ã€Œåˆ—å°ã€åŠŸèƒ½ï¼Œæˆ–æŒ‰ <span class="font-bold bg-gray-200 px-1 rounded">Ctrl + P</span>ã€‚
        </p>
    </div>

    <!-- A4 é è¦½å€ -->
    <div class="a4-paper" id="worksheet">
        <!-- å…§å®¹æœƒç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <script>
        // --- æ ¸å¿ƒé‚è¼¯å€ ---

        let showAnswer = false;
        let problems = [];

        // ç”¢ç”Ÿå–®ä¸€é¡Œç›®é‚è¼¯
        function generateSingleProblem(rows) {
            let nums = [];
            let currentSum = 0;

            // ç¬¬ä¸€å€‹æ•¸ (1-9)
            let first = Math.floor(Math.random() * 9) + 1;
            nums.push(first);
            currentSum = first;

            for (let i = 1; i < rows; i++) {
                let isAdd = Math.random() > 0.4; // 60% åŠ æ³•
                let val = Math.floor(Math.random() * 9) + 1;

                if (!isAdd) {
                    // æ¸›æ³•é‚è¼¯ï¼šç¢ºä¿ä¸å‡ºç¾è² æ•¸
                    if (currentSum - val >= 0) {
                        nums.push(-val);
                        currentSum -= val;
                    } else {
                        // ä¸å¤ æ¸›å‰‡æ”¹ç‚ºåŠ æ³• (ä¸”é™åˆ¶ç¸½å’Œä¸è¦éå¤§ï¼Œé©åˆåˆå­¸)
                        if (currentSum + val < 25) {
                            nums.push(val);
                            currentSum += val;
                        } else {
                            nums.push(0); // å¡«å…… 0 (å¯¦éš›ä¸Šæœƒé¡¯ç¤ºç‚ºç©ºæª”æˆ–ä¸é¡¯ç¤ºï¼Œé€™è£¡ç°¡å–®è™•ç†)
                        }
                    }
                } else {
                    // åŠ æ³•é‚è¼¯
                    if (currentSum + val < 25) {
                        nums.push(val);
                        currentSum += val;
                    } else {
                        let smallVal = Math.floor(Math.random() * (25 - currentSum));
                        if (smallVal === 0) smallVal = 1;
                        if (currentSum + smallVal < 30) {
                            nums.push(smallVal);
                            currentSum += smallVal;
                        } else {
                            nums.push(0);
                        }
                    }
                }
            }

            // ä¿®æ­£ 0 ç‚º 1 (é¿å…é¡Œç›®å‡ºç¾ +0)
            nums = nums.map(n => n === 0 ? 1 : n);
            const total = nums.reduce((a, b) => a + b, 0);

            return { nums, total };
        }

        // ç”¢ç”Ÿ A-J æ¨™é¡Œ
        function getColumnLabel(index) {
            const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            return labels[index % 10];
        }

        // æ¸²æŸ“ç•«é¢
        function render() {
            const worksheet = document.getElementById('worksheet');
            const rowsCount = parseInt(document.getElementById('rowsCount').value);
            const blockCount = parseInt(document.getElementById('blockCount').value);

            // æ¨™é¡Œ HTML
            let html = `
                <div class="text-center border-b-2 border-gray-800 pb-2 mb-2">
                    <h1 class="text-3xl font-black tracking-widest mb-1">ç å¿ƒç®—èƒ½åŠ›è¨“ç·´</h1>
                    <div class="flex justify-between text-sm mt-3 font-bold text-gray-600 px-1">
                        <span>ç­‰ç´šï¼š${rowsCount}å£åˆç´š</span>
                        <span class="tracking-[2em] mr-[-2em]">å§“åï¼š__________</span>
                        <span>æ—¥æœŸï¼š____/____</span>
                    </div>
                </div>
                <div class="flex flex-col gap-5">
            `;

            // ç”Ÿæˆé¡Œç›®å€å¡Š
            for (let b = 0; b < blockCount; b++) {
                html += `<div class="w-full print-break-inside-avoid">`; // åŠ å…¥é¿å…åˆ†é åˆ‡æ–·çš„ class

                // æ¨™é¡Œåˆ— A-J
                html += `<div class="grid grid-cols-10 border-t-2 border-l-2 border-r-2 border-black bg-gray-100 print:bg-gray-50">`;
                for (let i = 0; i < 10; i++) {
                    html += `<div class="text-center py-0.5 font-bold border-r border-black last:border-r-0 text-sm">${getColumnLabel(i)}</div>`;
                }
                html += `</div>`;

                // æ•¸å­—æ ¼
                html += `<div class="grid grid-cols-10 border-2 border-black">`;

                // æ¯ä¸€è¡Œçš„ 10 å€‹é¡Œç›®
                const startIdx = b * 10;
                const blockProblems = problems.slice(startIdx, startIdx + 10);

                blockProblems.forEach(prob => {
                    html += `<div class="border-r border-black last:border-r-0 flex flex-col">`;

                    // æ•¸å­—å †ç–Š
                    html += `<div class="flex-grow py-1 flex flex-col items-end px-2 gap-1 justify-center min-h-[3rem]">`;
                    prob.nums.forEach(num => {
                        html += `<span class="font-mono text-xl font-medium leading-none">${num}</span>`;
                    });
                    html += `</div>`;

                    // ç­”æ¡ˆæ ¼
                    html += `<div class="h-10 border-t border-black flex items-center justify-center bg-white">`;
                    if (showAnswer) {
                        html += `<span class="text-blue-600 font-bold text-lg">${prob.total}</span>`;
                    } else {
                        html += `<span class="text-transparent">.</span>`;
                    }
                    html += `</div></div>`;
                });

                html += `</div></div>`; // End grid & wrapper
            }

            html += `</div>`; // End container

            // é å°¾
            html += `
                <div class="mt-4 pt-2 border-t border-dashed border-gray-300 flex justify-between text-xs text-gray-400">
                    <div>Standard Abacus Worksheet - ${rowsCount} Rows x ${blockCount} Blocks</div>
                    <div>æ™‚é–“ï¼š______ åˆ† ______ ç§’</div>
                </div>
            `;

            worksheet.innerHTML = html;
        }

        // ç”Ÿæˆæ•¸æ“šä¸¦æ¸²æŸ“
        function generateSheet() {
            const rowsCount = parseInt(document.getElementById('rowsCount').value);
            const blockCount = parseInt(document.getElementById('blockCount').value);
            const totalQuestions = blockCount * 10;

            problems = [];
            for (let i = 0; i < totalQuestions; i++) {
                problems.push(generateSingleProblem(rowsCount));
            }
            render();
        }

        // åˆ‡æ›ç­”æ¡ˆé–‹é—œ
        function toggleAnswers() {
            showAnswer = !showAnswer;
            const btn = document.getElementById('btnAnswer');
            if (showAnswer) {
                btn.innerText = "éš±è—ç­”æ¡ˆ";
                btn.classList.add("bg-blue-100");
            } else {
                btn.innerText = "é¡¯ç¤ºç­”æ¡ˆ";
                btn.classList.remove("bg-blue-100");
            }
            render();
        }

        // ç›£è½è¨­å®šæ”¹è®Š
        document.getElementById('rowsCount').addEventListener('change', generateSheet);
        document.getElementById('blockCount').addEventListener('change', generateSheet);

        // åˆå§‹åŒ–
        window.onload = generateSheet;

    </script>
</body>

</html>